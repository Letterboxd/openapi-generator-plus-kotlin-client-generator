{{#join '_params' ', '}}
{{#each parameters}}
{{{name}}}: {{{nativeType}}}{{#unless required}} = null{{/unless}}
{{/each}}
{{#if requestBody.nativeType}}
{{#with requestBody}}
{{{name}}}: {{{nativeType}}}{{#unless required}} = null{{/unless}}
{{/with}}
{{/if}}
{{/join}}
{{#join '_callParams' ', '}}
{{#each parameters}}
{{{name}}}: {{{name}}}
{{/each}}
{{#if requestBody.nativeType}}
{{#with requestBody}}
{{{name}}}: {{{name}}}
{{/with}}
{{/if}}
{{/join}}
{{#join '_requestCallParams' ', '}}
{{#each parameters}}
{{{name}}}: __request.{{{name}}}
{{/each}}
{{#if requestBody.nativeType}}
{{#with requestBody}}
{{{name}}}: {{{name}}}
{{/with}}
{{/if}}
{{/join}}
sealed class {{className name}}Result {
{{#each responses}}
    {{#ifneq code 401}}

    {{#if description}}
    /**
     * {{#indent '     * '}}{{{description}}}{{/indent}}
     */
    {{/if}}
    {{#if defaultContent.nativeType}}
    data class _{{{code}}}(val value: {{{defaultContent.nativeType}}}): {{className ../name}}()
    {{else}}
    data object _{{{code}}}: {{className ../name}}()
    {{/if}}
    {{!-- data class _{{{code}}}{{#if defaultContent.nativeType}}(val value: {{{defaultContent.nativeType}}}){{/if}} --}}
    {{/ifneq}}
{{/each}}
    
}

{{#if (gt (count parameters) 1)}}
{{>frag/parametersStruct}}

{{>frag/operationDocumentation}}
{{#if deprecated}}
@kotlin.Deprecated(message = "This function is deprecated.")
{{/if}}
open suspend fun {{{name}}}(_ __request: {{{className (concat name '_' 'request')}}}{{#if requestBody.nativeType}}, {{{requestBody.name}}}: {{{requestBody.nativeType}}}{{#unless requestBody.required}} = nil{{/unless}}{{/if}}): {{className name}}Result {
    return try await {{{name}}}({{{_requestCallParams}}}{{#if requestBody.nativeType}}, {{{requestBody.name}}}: {{{requestBody.name}}}{{/if}})
}

{{/if}}
{{>frag/operationDocumentation}}
{{#if deprecated}}
@kotlin.Deprecated(message = "This function is deprecated.")
{{/if}}
open suspend fun {{{name}}}({{{_params}}}): {{className name}}Result {
    return try await {{{name}}}({{{_callParams}}}{{#if _params}}, {{/if}}allowsReauth: true)
}

private suspend fun {{{name}}}({{{_params}}}{{#if _params}}, {{/if}}allowsReauth: Bool): {{className name}}Result {
    val __request = try await {{{name}}}Request({{{_callParams}}})
    val (response, data) = try await URLSession.handleApiRequest(__request)
    switch response.statusCode {
{{#each responses}}
    {{#ifneq code 401}}
    case {{{code}}}:
    {{#if defaultContent.nativeType}}
        do {
            val decodedData = try JSONDecoder().decode({{{defaultContent.nativeType.concreteType}}}.self, from: data)
            return ._{{{code}}}(decodedData)
        } catch {
            throw APIError.invalidResponse(error, response: response, data: data)
        }
    {{else}}
        return ._{{{code}}}
    {{/if}}
    {{/ifneq}}
{{/each}}
{{#if securityRequirements}}
    case 401:
        if allowsReauth, val securityClient = configuration.securityClient {
            var didAuthenticate = false
            var lastError: Error?
            {{#each securityRequirements.requirements}}
            if !didAuthenticate {
                do {
                    {{#each schemes}}
                    try await securityClient.reauthenticate(failedRequest: __request, securityScheme: .{{{identifier scheme.name}}}, scopes: [{{#each scopes}}{{{stringLiteral name}}}{{#unless @last}}, {{/unless}}{{/each}}])
                    {{/each}}
                    didAuthenticate = true
                } catch (val error) {
                    lastError = error
                }
            }
            {{/each}}
            {{#unless securityRequirements.optional}}
            if !didAuthenticate {
                throw lastError!
            }
            {{/unless}}
            return try await {{{name}}}({{{_callParams}}}{{#if _callParams}}, {{/if}}allowsReauth: false)
        } else {
            throw APIError.authenticationFailed(response, data: data)
        }
{{/if}}
    default:
        throw APIError.unexpectedResponse(response, data: data)
    }
}

{{>frag/operationDocumentation}}
open suspend fun {{{name}}}Request({{{_params}}}): URLRequest {
    val localVarPath = "{{{group.path}}}{{{path}}}"
    {{#each pathParams}}
        .replacingOccurrences(of: "{{safe '{'}}{{{serializedName}}}{{safe '}'}}", with: String({{identifier name}}).addingPercentEncoding(withAllowedCharacters: .urlPathAllowed)!)
    {{/each}}

    var localVarHeaderParameter = [NameValuePair]()
    {{!-- Avoid Swift complaining that localVarHeaderParameter should be a val --}}
    localVarHeaderParameter.removeAll()

    var localVarUrlComponents = URLComponents(string: "\(self.basePath)\(localVarPath)")!
    var localVarQueryParameter = [NameValuePair]()
    if val localVarExistingQueryItems = localVarUrlComponents.queryItems {
        localVarQueryParameter.append(queryItems: localVarExistingQueryItems)
    }

{{#if queryParams}}
{{#each queryParams}}
    {{>frag/requestParameter dest='localVarQueryParameter' var=(identifier name) encoding=encoding}}
{{/each}}

{{/if}}
    localVarUrlComponents.queryItems = localVarQueryParameter.count > 0 ? localVarQueryParameter.toURLQueryItems() : null

    var localVarRequest = URLRequest(url: localVarUrlComponents.url!, cachePolicy: self.cachePolicy, timeoutInterval: self.timeoutInterval)
    localVarRequest.httpMethod = {{{stringLiteral httpMethod}}}

{{#each headerParams}}
    {{>frag/requestParameter dest='localVarHeaderParameter' var=(identifier name) encoding=encoding}}

{{/each}}
{{#if cookieParams}}
    var localVarCookieParams = [NameValuePair]()
{{#each cookieParams}}
    {{>frag/requestParameter dest='localVarCookieParams' var=(identifier name) encoding=encoding}}

{{/each}}
    localVarHeaderParameter.set("Cookie", localVarCookieParams.toString(separator: "; "))

{{/if}}
{{#if requestBody.nativeType}}
{{#with requestBody}}
    {{#if required}}
    {{>frag/requestBody}}
    {{else}}
    if val {{{name}}} = {{{name}}} {
        {{>frag/requestBody}}
    }
    {{/if}}
{{/with}}

{{/if}}
    localVarHeaderParameter.forEach { item in localVarRequest.addValue(item.value!, forHTTPHeaderField: item.name) }

    {{>frag/requestSecurity}}

    if val localVarFinalizeRequestBlock = self.configuration.finalizeRequestBlock {
        localVarFinalizeRequestBlock(&localVarRequest)
    }
    return localVarRequest
}

